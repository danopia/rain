<!doctype html>

<head>
  <title>Rain</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/site.css">

  <script src="main.js"></script>
  <script src="irc-parse.js"></script>
</head>

<body id="body">
    <div id="main"></div>
</body>

<script>
 let node = document.getElementById('main')
 let app = Elm.Main.embed(node)
 let scrollStick = true

 // Ask for permission to show notifications
 if (Notification.permission === 'default') { Notification.requestPermission() }

 window.addEventListener('wheel', () => {
     let messageBuffer = document.getElementById('buffer-messages')

     const padding = 50
     if (!messageBuffer || messageBuffer.scrollTop >= messageBuffer.scrollHeight - padding) {
         scrollStick = true
     } else {
         scrollStick = false
     }
 }, {passive: true})

 app.ports.refreshScrollPosition.subscribe(force => {
     // Bail if we're not at the bottom of the page (don't interrupt scrolling)
     if (!force && !scrollStick) {
         return
     }

     // DOM isn't fully rendered when we're called, so wait for it.
     window.requestAnimationFrame(() => {
         let messageBuffer = document.getElementById('buffer-messages')
         if (messageBuffer) messageBuffer.scrollTop = messageBuffer.scrollHeight
     })
 })

 app.ports.sendNotification.subscribe(args => {
     let [title, message] = args

     let notif = new Notification(title, {body: message})

     setTimeout(notif.close.bind(notif), 5000)
 })

 // push saved server configuration
 if (window.localStorage.savedServers) {
     let saved = JSON.parse(window.localStorage.savedServers)
     Object.keys(saved).forEach(k => {
         app.ports.addSavedServer.send(saved[k])
     })
 }
</script>
